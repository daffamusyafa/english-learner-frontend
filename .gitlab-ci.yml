# Tentukan tahapan (stages) dari pipeline Anda
stages:
  - build

# -------------------------------------------------------------------
# TAHAP 1: BUILD & PUSH IMAGE (Untuk Front-End)
# -------------------------------------------------------------------
# Mendefinisikan job untuk build dan push
build_and_push_to_dockerhub:
  stage: build
  
  # ▼ PENTING: TAMBAHKAN INI ▼
  # Memberi tahu job ini untuk mencari runner dengan tag 'docker'
  tags:
    - docker
  # ▲ ------------------- ▲
    
  # Menyediakan 'docker' CLI
  image: docker:20.10
  
  # Menjalankan 'docker' engine (daemon)
  services:
    - docker:20.10-dind
  
  variables:
    # Memberi tahu 'docker' CLI di mana menemukan 'docker' engine
    DOCKER_HOST: tcp://docker:2375
    # Menonaktifkan enkripsi (TLS)
    DOCKER_TLS_CERTDIR: ""
    # GANTI INI: Sesuaikan dengan nama image FE Anda di Docker Hub
    DOCKERHUB_IMAGE: "daffamusyafa/english-learner-frontend"

  script:
    - echo "Logging in to Docker Hub..."
    # Gunakan Variabel CI/CD GitLab: $DOCKERHUB_USERNAME, $DOCKERHUB_TOKEN
    - docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_TOKEN
    
    - echo "Building frontend Docker image..."
    # Pastikan Dockerfile di repo ini sudah benar untuk FE
    - docker build -t $DOCKERHUB_IMAGE:$CI_COMMIT_SHA .
    
    - echo "Creating 'latest' tag..."
    - docker tag $DOCKERHUB_IMAGE:$CI_COMMIT_SHA $DOCKERHUB_IMAGE:latest
    
    - echo "Pushing image to Docker Hub..."
    - docker push $DOCKERHUB_IMAGE:$CI_COMMIT_SHA
    - docker push $DOCKERHUB_IMAGE:latest
  
  # Hanya jalankan di branch 'master' (atau 'main', sesuaikan)
  only:
    - master