stages:
  - build_and_push

# --- JOB: BUILD & PUSH KE DOCKER HUB ---
push_to_dockerhub:
  stage: build_and_push
  image: docker:20.10
  services:
    - docker:20.10-dind
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    # Nama image di Docker Hub
    IMAGE_NAME: $DOCKERHUB_USERNAME/english-learner-frontend
  before_script:
    - echo "Logging in to Docker Hub..."
    # INI BAGIAN PENTING YANG BERBEDA DENGAN LOG ANDA
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - echo "Login successful."
  script:
    # 'IMAGE_TAG' akan diisi oleh 'rules' di bawah
    - echo "Building image $IMAGE_NAME:$IMAGE_TAG"
    - |
      docker build \
        --build-arg REACT_APP_API_URL=${PROD_API_URL} \
        -t $IMAGE_NAME:$IMAGE_TAG .
    - echo "Pushing image $IMAGE_NAME:$IMAGE_TAG"
    - docker push $IMAGE_NAME:$IMAGE_TAG
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      variables:
        IMAGE_TAG: "build-$CI_PIPELINE_IID"
    - if: $CI_COMMIT_TAG
      variables:
        IMAGE_TAG: $CI_COMMIT_TAG
